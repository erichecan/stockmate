// StockFlow Platform Database Schema
// Multi-tenant SaaS - Database-level isolation
// Updated: 2026-02-26T23:10:00

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// Platform-level Models (shared across all tenants)
// ============================================================

/// Tenant represents a company/organization using StockFlow
model Tenant {
  id          String       @id @default(uuid())
  name        String
  slug        String       @unique
  dbName      String       @unique @map("db_name")
  dbHost      String?      @map("db_host")
  plan        TenantPlan   @default(FREE)
  status      TenantStatus @default(ACTIVE)
  maxUsers    Int          @default(5) @map("max_users")
  contactName String?      @map("contact_name")
  email       String
  phone       String?
  address     String?
  logoUrl     String?      @map("logo_url")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  users             User[]
  categories        Category[]
  brands            Brand[]
  products          Product[]
  skus              Sku[]
  suppliers         Supplier[]
  warehouses        Warehouse[]
  binLocations      BinLocation[]
  purchaseOrders    PurchaseOrder[]
  shipments         Shipment[]
  purchaseReceipts  PurchaseReceipt[]
  inventoryItems    InventoryItem[]
  inventoryLedgers  InventoryLedger[]
  customers         Customer[]
  salesOrders       SalesOrder[]

  @@map("tenants")
}

enum TenantPlan {
  FREE
  PRO
  ENTERPRISE
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

/// Platform-level user record (auth + tenant association)
model User {
  id            String    @id @default(uuid())
  email         String
  passwordHash  String    @map("password_hash")
  firstName     String?   @map("first_name")
  lastName      String?   @map("last_name")
  role          UserRole  @default(VIEWER)
  isActive      Boolean   @default(true) @map("is_active")
  lastLoginAt   DateTime? @map("last_login_at")
  refreshToken  String?   @map("refresh_token")
  tenantId      String    @map("tenant_id")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([email, tenantId])
  @@index([tenantId])
  @@map("users")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  PURCHASER
  WAREHOUSE
  SALES
  VIEWER
}

// ============================================================
// Product Management (Phase 1 - in platform DB with tenant isolation)
// Updated: 2026-02-27T04:30:00
// ============================================================

/// Product category tree (e.g. Phone Cases → iPhone → iPhone 16 Pro Max)
model Category {
  id        String   @id @default(uuid())
  name      String
  nameEn    String?  @map("name_en")
  code      String
  parentId  String?  @map("parent_id")
  tenantId  String   @map("tenant_id")
  sortOrder Int      @default(0) @map("sort_order")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  parent   Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children Category[] @relation("CategoryTree")
  tenant   Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  products Product[]

  @@unique([code, tenantId])
  @@index([tenantId])
  @@map("categories")
}

/// Brand (e.g. Apple, Samsung, Xiaomi)
model Brand {
  id        String   @id @default(uuid())
  name      String
  code      String
  tenantId  String   @map("tenant_id")
  logoUrl   String?  @map("logo_url")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  products Product[]

  @@unique([code, tenantId])
  @@index([tenantId])
  @@map("brands")
}

/// SPU - Standard Product Unit (e.g. iPhone 16 PM Clear Silicone Case)
model Product {
  id            String        @id @default(uuid())
  name          String
  nameEn        String?       @map("name_en")
  description   String?
  descriptionEn String?       @map("description_en")
  categoryId    String        @map("category_id")
  brandId       String?       @map("brand_id")
  tenantId      String        @map("tenant_id")
  status        ProductStatus @default(DRAFT)
  images        Json?
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  category Category @relation(fields: [categoryId], references: [id])
  brand    Brand?   @relation(fields: [brandId], references: [id])
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  skus     Sku[]

  @@index([tenantId])
  @@index([categoryId])
  @@map("products")
}

enum ProductStatus {
  DRAFT
  PRE_ORDER
  ACTIVE
  DISCONTINUED
}

/// SKU - Stock Keeping Unit (specific variant with auto-generated code)
model Sku {
  id                String   @id @default(uuid())
  code              String
  productId         String   @map("product_id")
  tenantId          String   @map("tenant_id")
  variantAttributes Json     @map("variant_attributes")
  barcode           String?
  costPrice         Decimal? @map("cost_price") @db.Decimal(10, 2)
  wholesalePrice    Decimal? @map("wholesale_price") @db.Decimal(10, 2)
  retailPrice       Decimal? @map("retail_price") @db.Decimal(10, 2)
  weight            Decimal? @db.Decimal(8, 3)
  images            Json?
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  product         Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  poItems         PurchaseOrderItem[]
  soItems         SalesOrderItem[]
  inventoryItems  InventoryItem[]
  inventoryLedgers InventoryLedger[]

  @@unique([code, tenantId])
  @@index([productId])
  @@index([tenantId])
  @@map("skus")
}

// ============================================================
// Phase 2: Supplier, Warehouse, Purchasing, Inventory
// Updated: 2026-02-27T10:00:00
// ============================================================

/// Supplier for purchasing
model Supplier {
  id          String   @id @default(uuid())
  name        String
  code        String
  tenantId    String   @map("tenant_id")
  contactName String?  @map("contact_name")
  email       String?
  phone       String?
  address     String?
  country     String?
  paymentTerms String? @map("payment_terms")
  leadTimeDays Int?    @map("lead_time_days")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  purchaseOrders PurchaseOrder[]

  @@unique([code, tenantId])
  @@index([tenantId])
  @@map("suppliers")
}

/// Warehouse (e.g. Main Warehouse, FBA Prep Center)
model Warehouse {
  id        String   @id @default(uuid())
  name      String
  code      String
  tenantId  String   @map("tenant_id")
  address   String?
  city      String?
  country   String?
  isDefault Boolean  @default(false) @map("is_default")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  binLocations   BinLocation[]
  inventoryItems  InventoryItem[]
  inventoryLedgers InventoryLedger[]
  salesOrders    SalesOrder[]

  @@unique([code, tenantId])
  @@index([tenantId])
  @@map("warehouses")
}

/// Bin location within a warehouse (WH01-A-01-01-01 = warehouse-zone-aisle-shelf-position)
model BinLocation {
  id          String   @id @default(uuid())
  code        String
  warehouseId String   @map("warehouse_id")
  tenantId    String   @map("tenant_id")
  zone        String?
  aisle       String?
  shelf       String?
  position    String?
  barcode     String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  warehouse      Warehouse       @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  inventoryItems InventoryItem[]

  @@unique([code, tenantId])
  @@index([warehouseId])
  @@index([tenantId])
  @@map("bin_locations")
}

/// Purchase Order
model PurchaseOrder {
  id             String        @id @default(uuid())
  orderNumber    String        @map("order_number")
  tenantId       String        @map("tenant_id")
  supplierId     String        @map("supplier_id")
  status         POStatus      @default(DRAFT)
  totalAmount    Decimal?      @map("total_amount") @db.Decimal(12, 2)
  currency       String        @default("USD")
  notes          String?
  orderedAt      DateTime?     @map("ordered_at")
  expectedAt     DateTime?     @map("expected_at")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  tenant    Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  supplier  Supplier            @relation(fields: [supplierId], references: [id])
  items     PurchaseOrderItem[]
  shipments Shipment[]
  receipts  PurchaseReceipt[]

  @@unique([orderNumber, tenantId])
  @@index([tenantId])
  @@index([supplierId])
  @@map("purchase_orders")
}

enum POStatus {
  DRAFT
  CONFIRMED
  SHIPPED
  IN_TRANSIT
  ARRIVED
  COMPLETED
  CANCELLED
}

/// Purchase Order line item
model PurchaseOrderItem {
  id              String   @id @default(uuid())
  purchaseOrderId String   @map("purchase_order_id")
  skuId           String   @map("sku_id")
  quantity        Int
  unitPrice       Decimal  @map("unit_price") @db.Decimal(10, 2)
  receivedQty     Int      @default(0) @map("received_qty")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  sku           Sku           @relation(fields: [skuId], references: [id])
  receiptItems  ReceiptItem[]

  @@index([purchaseOrderId])
  @@map("purchase_order_items")
}

/// Shipment / Container tracking for sea freight
model Shipment {
  id              String         @id @default(uuid())
  purchaseOrderId String         @map("purchase_order_id")
  tenantId        String         @map("tenant_id")
  containerNo     String?        @map("container_no")
  vesselName      String?        @map("vessel_name")
  status          ShipmentStatus @default(PENDING)
  etd             DateTime?
  eta             DateTime?
  atd             DateTime?
  ata             DateTime?
  portOfLoading   String?        @map("port_of_loading")
  portOfDischarge String?        @map("port_of_discharge")
  shippingCost    Decimal?       @map("shipping_cost") @db.Decimal(10, 2)
  notes           String?
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  purchaseOrder PurchaseOrder    @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  tenant        Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  packingLists  PackingListItem[]

  @@index([purchaseOrderId])
  @@index([tenantId])
  @@map("shipments")
}

enum ShipmentStatus {
  PENDING
  LOADED
  IN_TRANSIT
  ARRIVED
  DELIVERED
}

/// Packing list item (carton → SKU mapping)
model PackingListItem {
  id          String   @id @default(uuid())
  shipmentId  String   @map("shipment_id")
  cartonNo    String   @map("carton_no")
  skuCode     String   @map("sku_code")
  skuName     String?  @map("sku_name")
  quantity    Int
  grossWeight Decimal? @map("gross_weight") @db.Decimal(8, 3)
  netWeight   Decimal? @map("net_weight") @db.Decimal(8, 3)
  cbm         Decimal? @db.Decimal(8, 4)
  barcode     String?
  createdAt   DateTime @default(now()) @map("created_at")

  shipment Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@index([shipmentId])
  @@map("packing_list_items")
}

/// Purchase receipt (receiving record against a PO)
model PurchaseReceipt {
  id              String        @id @default(uuid())
  receiptNumber   String        @map("receipt_number")
  purchaseOrderId String        @map("purchase_order_id")
  tenantId        String        @map("tenant_id")
  status          ReceiptStatus @default(PENDING)
  receivedAt      DateTime?     @map("received_at")
  notes           String?
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items         ReceiptItem[]

  @@unique([receiptNumber, tenantId])
  @@index([purchaseOrderId])
  @@index([tenantId])
  @@map("purchase_receipts")
}

enum ReceiptStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

/// Receipt line item with discrepancy tracking
model ReceiptItem {
  id              String            @id @default(uuid())
  receiptId       String            @map("receipt_id")
  poItemId        String            @map("po_item_id")
  expectedQty     Int               @map("expected_qty")
  receivedQty     Int               @map("received_qty")
  damagedQty      Int               @default(0) @map("damaged_qty")
  discrepancyType DiscrepancyType?  @map("discrepancy_type")
  notes           String?
  createdAt       DateTime          @default(now()) @map("created_at")

  receipt PurchaseReceipt   @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  poItem  PurchaseOrderItem @relation(fields: [poItemId], references: [id])

  @@index([receiptId])
  @@map("receipt_items")
}

enum DiscrepancyType {
  SHORT
  OVER
  DAMAGED
  WRONG_ITEM
}

/// Inventory by SKU × Warehouse × BinLocation
model InventoryItem {
  id            String   @id @default(uuid())
  skuId         String   @map("sku_id")
  warehouseId   String   @map("warehouse_id")
  binLocationId String?  @map("bin_location_id")
  tenantId      String   @map("tenant_id")
  quantity      Int      @default(0)
  lockedQty     Int      @default(0) @map("locked_qty")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  sku         Sku          @relation(fields: [skuId], references: [id])
  warehouse   Warehouse    @relation(fields: [warehouseId], references: [id])
  binLocation BinLocation? @relation(fields: [binLocationId], references: [id])
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([skuId, warehouseId, binLocationId, tenantId])
  @@index([tenantId])
  @@index([warehouseId])
  @@map("inventory_items")
}

/// Inventory ledger - immutable log of all stock movements
model InventoryLedger {
  id            String       @id @default(uuid())
  skuId         String       @map("sku_id")
  warehouseId   String       @map("warehouse_id")
  tenantId      String       @map("tenant_id")
  type          LedgerType
  quantity      Int
  referenceType String?      @map("reference_type")
  referenceId   String?      @map("reference_id")
  notes         String?
  operatorId    String?      @map("operator_id")
  createdAt     DateTime     @default(now()) @map("created_at")

  sku       Sku       @relation(fields: [skuId], references: [id])
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([skuId])
  @@index([warehouseId])
  @@index([tenantId])
  @@index([createdAt])
  @@map("inventory_ledgers")
}

enum LedgerType {
  INBOUND
  OUTBOUND
  ADJUSTMENT
  TRANSFER
  LOCK
  UNLOCK
  RETURN
}

// ============================================================
// Phase 3: Customer & Sales Order (批发销售)
// Updated: 2026-02-28T14:00:00
// ============================================================

model Customer {
  id          String       @id @default(uuid())
  name        String
  code        String
  tenantId    String       @map("tenant_id")
  contactName String?      @map("contact_name")
  email       String?
  phone       String?
  address     String?
  city        String?
  country     String?
  tier        CustomerTier @default(NORMAL)
  isActive    Boolean      @default(true) @map("is_active")
  notes       String?
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  salesOrders SalesOrder[]

  @@unique([code, tenantId])
  @@index([tenantId])
  @@map("customers")
}

enum CustomerTier {
  NORMAL
  SILVER
  GOLD
  VIP
}

model SalesOrder {
  id          String       @id @default(uuid())
  orderNumber String       @map("order_number")
  tenantId    String       @map("tenant_id")
  customerId  String       @map("customer_id")
  warehouseId String       @map("warehouse_id")
  status      SOStatus     @default(PENDING)
  totalAmount Decimal?     @map("total_amount") @db.Decimal(12, 2)
  currency    String       @default("EUR")
  notes       String?
  source      OrderSource  @default(MANUAL)
  externalId  String?      @map("external_id")
  orderedAt   DateTime?    @map("ordered_at")
  shippedAt   DateTime?    @map("shipped_at")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  tenant    Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer  Customer        @relation(fields: [customerId], references: [id])
  warehouse Warehouse       @relation(fields: [warehouseId], references: [id])
  items     SalesOrderItem[]

  @@unique([orderNumber, tenantId])
  @@index([tenantId])
  @@index([customerId])
  @@index([warehouseId])
  @@map("sales_orders")
}

model SalesOrderItem {
  id           String   @id @default(uuid())
  salesOrderId String   @map("sales_order_id")
  skuId        String   @map("sku_id")
  quantity     Int
  unitPrice    Decimal  @map("unit_price") @db.Decimal(10, 2)
  pickedQty    Int      @default(0) @map("picked_qty")
  createdAt    DateTime @default(now()) @map("created_at")

  salesOrder SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  sku        Sku        @relation(fields: [skuId], references: [id])

  @@index([salesOrderId])
  @@index([skuId])
  @@map("sales_order_items")
}

enum SOStatus {
  PENDING
  CONFIRMED
  PICKING
  PACKED
  SHIPPED
  COMPLETED
  CANCELLED
}

enum OrderSource {
  MANUAL
  SHOPIFY
}
